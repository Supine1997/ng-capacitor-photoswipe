stages:
  - build
  - clean-dist
  - push
  - clean

variables:
  ORIGIN_SSH_URL: "git@192.168.3.168:tool/ng-capacitor-photoswipe.git"

cache:
  paths:
    - node_modules
    - dist
    - .git

build-job:
  stage: build
  only:
    - master
  script:
    - git checkout master # åˆ‡æ¢åˆ°masteråˆ†æ”¯
    - git checkout deploy # åˆ‡æ¢åˆ°deployåˆ†æ”¯
    - git merge master # åˆå¹¶masteråˆ°deployåˆ†æ”¯
    - npm install # å®‰è£…ä¾èµ–
    - npm run build # ç¼–è¯‘

clean-dist-job:
  stage: clean-dist
  only:
    - master
  script:
    - git rm --cached -r dist # åˆ é™¤å·²å­˜åœ¨distæ–‡ä»¶å¤¹ç¼“å­˜
    - git commit -m 'ğŸš® dist' # æäº¤æ›´æ”¹åˆ°æœ¬åœ°ä»“åº“
  allow_failure: true

push-job:
  stage: push
  only:
    - master
  script:
    - git remote set-url origin $ORIGIN_SSH_URL # é‡å®šå‘ä¸ºssh
    - git add -f dist # æš‚å­˜distæ–‡ä»¶å¤¹
    - git commit -m 'âœ… dist' # æäº¤æ›´æ”¹åˆ°æœ¬åœ°ä»“åº“
    - git push # æ¨é€åˆ°è¿œç¨‹deployåˆ†æ”¯

clean-job:
  stage: clean
  only:
    - master
  script:
    - rm -f -r .git dist #åˆ é™¤.git dist é˜²æ­¢è¢«ç¼“å­˜
  allow_failure: true
  when: always

